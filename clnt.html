<!DOCTYPE html>
<html>
<head>
  <title>WhatsApp-like Chat</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; }
    #chat { height: 400px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; }
    #users { margin: 10px 0; color: #555; }
    .message { margin: 5px 0; }
    .message.sent { text-align: right; color: #4CAF50; }
    .message.received { text-align: left; color: #2196F3; }
    .notification { color: #888; font-style: italic; }
    .typing { color: #FF9800; }
  </style>
</head>
<body>
  <h1>WhatsApp-like Chat</h1>
  <div id="users">Online: Loading...</div>
  <div id="chat"></div>
  <input type="text" id="username" placeholder="Your name" style="display: block; width: 100%; margin-bottom: 10px;">
  <input type="text" id="message" placeholder="Type a message..." style="width: 70%;">
  <button id="send">Send</button>

  <script>
    const socket = new WebSocket('https://cab-1-fw0r.onrender.com');
    const chatDiv = document.getElementById('chat');
    const usersDiv = document.getElementById('users');
    const messageInput = document.getElementById('message');
    const usernameInput = document.getElementById('username');
    const sendButton = document.getElementById('send');

    let username = null;

    // Join chat when username is entered
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && usernameInput.value.trim()) {
        username = usernameInput.value.trim();
        usernameInput.style.display = 'none';
        socket.send(JSON.stringify({ type: 'join', username: username }));
      }
    });

    // Send message
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Typing indicator
    messageInput.addEventListener('input', () => {
      socket.send(JSON.stringify({
        type: 'typing',
        isTyping: messageInput.value.length > 0
      }));
    });

    function sendMessage() {
      if (messageInput.value.trim()) {
        socket.send(JSON.stringify({
          type: 'message',
          text: messageInput.value
        }));
        addMessage('You: ' + messageInput.value, 'sent');
        messageInput.value = '';
      }
    }

    // Handle incoming messages
    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'notification') {
        addMessage(data.text, 'notification');
        usersDiv.textContent = `Online: ${data.users.join(', ')}`;
      }
      else if (data.type === 'message') {
        addMessage(`${data.username}: ${data.text}`, 'received');
      }
      else if (data.type === 'typing') {
        const typingMsg = document.getElementById('typing');
        if (data.isTyping) {
          if (!typingMsg) {
            const msg = document.createElement('div');
            msg.id = 'typing';
            msg.className = 'typing';
            msg.textContent = `${data.username} is typing...`;
            chatDiv.appendChild(msg);
          }
        } else if (typingMsg) {
          typingMsg.remove();
        }
      }
    };

    function addMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      chatDiv.appendChild(msg);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
  </script>
</body>
</html>
